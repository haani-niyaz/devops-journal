---
layout: post
title:  "lsof Notebook"
date:   2018-09-15
author: "Haani Niyaz"
tags: 
 - lsof
 - tutorial
---


## Getting info about the Network


### lsof `-i` Options

The following is a snippet from the `lsof` man pages. It describes the syntax available when using the `-i` option.

{% highlight bash %}
[46][protocol][@hostname|hostaddr][:service|port]
{% endhighlight %}

Where:

`46` specifies the IP version, IPv4 or IPv6
          that applies to the following address.
          '6' may be be specified only if the UNIX
          dialect supports IPv6.  If neither '4' nor
          '6' is specified, the following address
          applies to all IP versions.

`protocol` is a protocol name - TCP, UDP

`hostname` is an Internet host name.  Unless a
          specific IP version is specified, open
          network files associated with host names
          of all versions will be selected.

`hostaddr` is a numeric Internet IPv4 address in
          dot form; or an IPv6 numeric address in
          colon form, enclosed in brackets, if the
          UNIX dialect supports IPv6.  When an IP
          version is selected, only its numeric
          addresses may be specified.

`service` is an /etc/services name - e.g., smtp -
          or a list of them.

`port` is a port number, or a list of them.


### TCP Socket States


`LISTEN`  

Wait for remote machine end to contact us

`ESTABLISHED` 

Ready for communication

`CLOSE WAIT` 

Remote machine has already closed the connection, but the local program has received a termination request and acknowledged it but is pending an active close.


#### Show all TCP connections

{% highlight bash %}

$ lsof -iTCP
COMMAND    PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
Google     341 haani   67u  IPv4 0xaa278530b6289f9b      0t0  TCP 192.168.0.4:49792->stackoverflow.com:https (ESTABLISHED)
Google     341 haani  138u  IPv4 0xaa278530b500e6a3      0t0  TCP localhost:50373->localhost:terabase (CLOSE_WAIT)
Google     341 haani  142u  IPv4 0xaa278530b49432c3      0t0  TCP 192.168.0.4:49197->108.177.125.188:5228 (ESTABLISHED)
Google     341 haani  143u  IPv4 0xaa278530b500c2c3      0t0  TCP 192.168.0.4:49375->syd15s02-in-f46.1e100.net:http (CLOSED)


{% endhighlight %}

Note the `COMMAND` and `PID`in the output.



#### TCP connection to a host and port

{% highlight bash %}

$lsof -iTCP@108.177.125.188:5228
COMMAND   PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
Google    341 haani  142u  IPv4 0xaa278530b49432c3      0t0  TCP 192.168.0.4:49197->108.177.125.188:5228 (ESTABLISHED)

{% endhighlight %}

#### Only show PID for TCP connections

{% highlight bash %}

$ lsof -iTCP@108.177.125.188:5228 -t
341

{% endhighlight %}


#### TCP connections where the socket state is 'LISTEN'

{% highlight bash %}

 # -s p:s  exclude(^)|select protocol (p = TCP|UDP) states by name(s).
$ lsof -iTCP -sTCP:LISTEN

{% endhighlight %}


#### All TCP connection states except for 'LISTEN'

{% highlight bash %}

# -s p:s  exclude(^)|select protocol (p = TCP|UDP) states by name(s).
$ lsof -iTCP -sTCP:^LISTEN

{% endhighlight %}

#### See a what a given `COMMAND` is doing

{% highlight bash %}

 lsof -iTCP -c Google 
COMMAND    PID  USER   FD      TYPE             DEVICE  SIZE/OFF    NODE NAME
Google     341 haani  cwd       DIR                1,4      1122       2 /
...

{% endhighlight %}


#### See a what a given process is doing

{% highlight bash %}

$ lsof -iTCP@108.177.125.188:5228 -p 341 
COMMAND   PID  USER   FD      TYPE             DEVICE  SIZE/OFF    NODE NAME
Google    341 haani  cwd       DIR                1,4      1122       2 /
...

{% endhighlight %}